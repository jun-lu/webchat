var WE={extend:$.extend,ui:{},kit:{},api:{},page:{},markdown:{},Observer:{notice:function(){Array.prototype.unshift.call(arguments,{target:this,data:arguments[0]});for(var a=0;this.observers&&a<this.observers.length;a++)try{this.observers[a].update.apply(this.observers[a],arguments)}catch(b){window.console&&console.log(b)}},addObserver:function(a){a&&a.update?(this.observers||(this.observers=[]),this.observers.push(a)):console.error("observer.update not fucntion ")},removeObserver:function(a){for(var b=
0;this.observers&&b<this.observers.length;b++)a===this.observers[b]&&(this.observers.splice(b,1),b--)}},Controller:function(a){this.msg={"-99":"\u670d\u52a1\u5668\u9519\u8bef"};a&&WE.extend(this,a)}};WE.Controller.prototype={constructor:WE.Controller,update:function(a){0!=a.code&&WE.ui.alert(this.getCodeMsg(a.code))},error:function(a){window.console&&console.log("xhr \u9519\u8bef",a.status)},getCodeMsg:function(a){var b=this.msg?this.msg[a]:null;return b?b:"\u9519\u8bef\u4ee3\u7801:"+a}};
WE.BaseModel=function(a){this.init(a)};WE.BaseModel.prototype={constructor:WE.BaseModel,init:function(a){a&&WE.extend(this,a)},error:function(a,b){for(var c=this.observers,d=0;c&&d<c.length;d++)c[d].error&&c[d].error(a,b)},post:function(a,b){var c=this;$.ajax({url:a,type:"post",data:b,dataType:"json",error:function(a,b){c.error(a,b)},success:function(a){c.notice(a)}})},get:function(a,b){var c=this;$.ajax({url:a,type:"get",data:b,dataType:"json",error:function(a,b){c.error(a,b)},success:function(a){c.notice(a)}})}};
WE.extend(WE.BaseModel.prototype,WE.Observer);WE.extend(WE.kit,{cache:{},tmpl:function(a,b){var c=/\W/.test(a)?new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+a.replace(/[\r\t\n]/g," ").split("<%").join("\t").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("\t").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');"):cache[a]=cache[a]||tmpl(document.getElementById(a).innerHTML);return b?c(b):c},pad:function(a,b,c){if(0>b-String(a).length)return a;
b=Array(b-String(a).length||0);b.push(a);return b.join(c||"0")},format:function(a,b){a=new Date(a);var c=this.pad,d={yy:String(a.getFullYear()).slice(-2),yyyy:a.getFullYear(),M:a.getMonth()+1,MM:c(a.getMonth()+1,2,"0"),d:a.getDate(),dd:c(a.getDate(),2,"0"),h:a.getHours(),hh:c(a.getHours(),2,"0"),m:a.getMinutes(),mm:c(a.getMinutes(),2,"0"),s:a.getSeconds(),ss:c(a.getSeconds(),2,"0")};return(b||"yyyy-MM-dd hh:mm:ss").replace(/yyyy|yy|MM|M|dd|d|hh|h|mm|m|ss|s/g,function(a){return d[a]})},weFormat:function(a){var b=
"",c=new Date(a),d=new Date;a=d.getFullYear();var e=d.getMonth()+1,d=d.getDate(),k=c.getFullYear(),f=c.getMonth()+1,g=c.getDate(),h=[k,f,g],c=[c.getHours(),c.getMinutes(),c.getSeconds()];k==a?f==e?b=g==d?"Today "+c.join(":"):1==g-d?"Yesterday "+c.join(":"):h.splice(1,3).join("-")+" "+c.join(":"):f!=e&&(b=h.splice(1,3).join("-")+" "+c.join(":")):b=h.join("-")+" "+c.join(":");return b},sortFormat:function(a){return this.format(a,"yyyy-MM-dd")},longFormat:function(a){return this.format(a,"yyyy-MM-dd hh:mm:ss")},
getTmpl:function(a,b){var c=this;c.cache[a]?b&&b(c.cache[a]):$.ajax({url:"/api/tmpl",medthod:"get",data:{path:a},success:function(d){c.cache[a]=d;b&&b(d)}})},cutOff:function(a,b){return a.length>b?a.slice(0,b)+"...":a},getRadioValue:function(a){return $("input[type=radio][name="+a+"]:checked").val()},weTime:function(){var a=[{t:6E4,s:"\u521a\u521a"},{t:12E4,s:"1\u5206\u949f"},{t:18E4,s:"2\u5206\u949f"},{t:36E4,s:"5\u5206\u949f"},{t:66E4,s:"10\u5206\u949f"},{t:18E5,s:"30\u5206\u949f"},{t:36E5,s:"1\u5c0f\u65f6"},
{t:72E5,s:"2\u5c0f\u65f6"},{t:18E6,s:"5\u5c0f\u65f6"},{t:864E5,s:"1\u5929\u524d"},{t:1728E5,s:"2\u5929\u524d"}];return function(b){for(var c=(new Date).getTime()-b,d=0;d<a.length;)if(a[d++].t>c)return a[d-1].s;return WE.kit.format(b,"MM-dd hh:mm:ss")}}(),getAvatar:function(a,b,c){return"http://www.gravatar.com/avatar/"+(a||"00000000000000000000000000000000")+"?s="+(b||48)+"&d="+(c||"mm")},chatFormate:function(a){return a.replace(/\n/gi,"<br/>").replace(/http:\/\/[\w\.\/\:\?\&\=\#\-\_]+/gi,function(a){return'<a href="'+
a+'" target="_blank">'+a+"</a>"})},removeHtmlTag:function(a){return a.replace(/<|>/g,function(a){return"<"==a?"&lt;":"&gt;"})},revertHtmlTag:function(a){return a.replace(/\n/gi,"<br/>").replace(/http:\/\/[\w\.\/\:\?\&\=\#\-\_]+/gi,function(a){return'<a href="'+a+'" target="_blank">'+a+"</a>"})},getHidden:function(){var a;"undefined"!==typeof document.hidden?a="hidden":"undefined"!==typeof document.mozHidden?a="mozHidden":"undefined"!==typeof document.msHidden?a="msHidden":"undefined"!==typeof document.webkitHidden&&
(a="webkitHidden");return document[a]},titleRoll:function(a,b){var c=a.split("");setInterval(function(){c.push(c[0]);c.shift();document.title=c.join("")},b)}});WE.extend(WE.ui,{ok:function(a,b){var c=this.tip({context:a,okbtn:!1,cancelbtn:!1,type:"success",timeout:b||3E3,title:"\u63d0\u793a"});c.ui.close.focus();return c},alert:function(a,b){this.alert.tip&&(this.alert.tip.option.callback=null,this.alert.tip.close());var c=this.tip({context:a,cancelbtn:!1,type:"notice",callback:b,title:"\u63d0\u793a"});c.ui.ok.focus();return this.alert.tip=c},confirm:function(a,b){if(this.confirm.tip)return this.confirm.tip;var c=this,d=this.tip({context:a,closebtn:!1,type:"notice",
callback:function(a){c.confirm.tip=null;b&&b("ok"==a?!0:!1)},title:"\u63d0\u793a"});this.confirm.tip=d;d.ui.ok.focus();return d},tip:function(){function a(a){this.option={title:"\u63d0\u793a",context:"hello world",callback:function(){},timeout:0,okbtn:!0,cancelbtn:!0,closebtn:!0,type:"notice"};$.extend(this.option,a);this.init()}a.prototype={init:function(){var a=WE.kit.tmpl('<div class="moxian-ui-tip">\t\t\t\t<div class="ui-tip-wrapper">\t\t\t\t\t<div class="ui-tip-main">\t\t\t\t\t\t<div class="ui-tip-title">\t\t\t\t\t\t\t<h1><%=title%></h1>\t\t\t\t\t\t\t<%if(closebtn){%>\t\t\t\t\t\t\t<input type="button" class="ui-btn-close pngbg" title="\u5173\u95ed" />\t\t\t\t\t\t\t<%}%>\t\t\t\t\t\t</div>\t\t\t\t\t\t<div class="ui-tip-context">\t\t\t\t\t\t\t<%if(type){%>\t\t\t\t\t\t\t<p class="p">\t\t\t\t\t\t\t\t<span class="ui-tip-icon ui-tip-<%=type%>"></span><span><%=context%></span>\t\t\t\t\t\t\t</p>\t\t\t\t\t\t\t<%}else{%>\t\t\t\t\t\t\t\t<%=context%>\t\t\t\t\t\t\t<%}%>\t\t\t\t\t\t</div>\t\t\t\t\t\t<div class="ui-tip-btn">\t\t\t\t\t\t\t<%if(okbtn){%>\t\t\t\t\t\t\t\t<input type="button" title="\u786e\u5b9a" class="btn-primary js_ok" value="\u786e\u5b9a" />\t\t\t\t\t\t\t<%}%>\t\t\t\t\t\t\t<%if(cancelbtn){%>\t\t\t\t\t\t\t\t<input type="button" title="\u53d6\u6d88" class="btn marl10 js_cancel" value="\u53d6\u6d88" />\t\t\t\t\t\t\t<%}%>\t\t\t\t\t\t</div>\t\t\t\t\t</div>\t\t\t\t</div>\t\t\t\t<div class="ui-tip-bg">\u80cc\u666f</div>\t\t\t</div>',
this.option),a=$("<div></div>").append(a);this.ui={wrapper:a.find(".moxian-ui-tip"),title:a.find(".ui-tip-title"),close:a.find(".ui-btn-close"),ok:a.find(".js_ok"),cancel:a.find(".js_cancel")};$(document.body).append(a.find(".moxian-ui-tip"));this.regEvent();this.option.timeout&&this.setTimeout(this.option.timeout);(new WE.kit.DragElement({dragElement:this.ui.title,moveElement:this.ui.wrapper,isRange:!1,isResize:!1,offsetTop:0})).init();this.updatePos()},regEvent:function(){function a(d){27==d.keyCode&&
(c.close("close"),$(window).unbind("keyup",a))}var c=this;this.ui.close.click(function(){c.close("close")});this.ui.ok.click(function(){c.close("ok")});this.ui.cancel.click(function(){c.close("cancel")});$(document).keyup(a)},close:function(a){this.ui.wrapper.remove();this.option.callback&&this.option.callback(a)},updatePos:function(){var a=$(window).height(),c=$(window).width();this.setPos((a-this.ui.wrapper.height())/2,(c-this.ui.wrapper.width())/2)},setTimeout:function(a){var c=this;setTimeout(function(){c.close("auto")},
a)},setPos:function(a,c){this.ui.wrapper.css({top:a+"px",left:c+"px"})}};return function(b){return new a(b)}}()});WE.extend(WE.markdown,{defaultPrefix:"```",format:function(a){if(0<String(a).length){a=a.split(this.defaultPrefix);for(var b=-1,c=0;c<a.length;c++)-1==b?(b=c,a[c]=WE.kit.removeHtmlTag(a[c]),a[c]=this.lineFormat(a[c]),a[c]=this.urlFormat(a[c])):(a[b+1]="<pre>"+a[b+1],a[c]+="</pre>",b=-1);return a.join("")}return a},urlFormat:function(a){return a.replace(/(http|https):\/\/[\w\.\/\:\?\&\=\#\-\_]+/gi,function(a){return'<a href="'+a+'" target="_blank">'+a+"</a>"})},lineFormat:function(a){return a.replace(/\n/gi,
"<br/>")}});WE.Dialog=function(a){var b=null;if((this.id=a.id)&&WE.Dialog.getItem(this.id))return b=WE.Dialog.getItem(this.id),b.isRepeat=!0,b.isRepeat;this.title=a.title||"";this.html=a.html;this.width=a.width||200;this.height=a.height||60;this.wrap=$(WE.Dialog.html.replace("<%=title%>",this.title));this.ui={wrap:this.wrap,mask:this.wrap.find(".we-mask"),dialog:this.wrap.find(".we-dialog"),context:this.wrap.find(".we-dialog-context")};this.init()};WE.Dialog.html='<div class="we-dialog-box">\t\t<div class="we-mask" style="opacity:0" ></div>\t\t<div class="we-dialog" style="opacity:0">\t\t\t<div class="we-dialog-title">\t\t\t\t<h1><%=title%></h1>\t\t\t\t<a href="javascript:;" class="we-dialog-close out"></a>\t\t\t</div>\t\t\t<div class="we-dialog-context we-loading"></div>\t\t</div>\t</div>';
WE.Dialog.list={};WE.Dialog.getItem=function(a){return this.list[a]};WE.Dialog.setItem=function(a,b){this.list[a]=b};WE.Dialog.remove=function(a){this.list[a]=null};
WE.Dialog.prototype={constructor:WE.Dialog,init:function(){var a=this;this.id&&WE.Dialog.setItem(this.id,this);document.body.appendChild(this.ui.wrap[0]);this.updatePosition();this.ui.wrap.delegate(".out","click",function(){a.close(1)})},append:function(a){this.ui.context.html(a).removeClass("we-loading");this.updatePosition()},updatePosition:function(){this.width=this.ui.dialog.width();this.height=this.ui.dialog.height();this.ui.dialog.css({top:0.6*(($(window).height()-this.height)/2)+"px",left:($(window).width()-
this.width)/2+"px"})},show:function(){this.ui.mask.animate({opacity:1},300);this.ui.dialog.animate({marginTop:"+=10px",opacity:1},300)},close:function(a){var b=this;this.ui.mask.animate({opacity:0},300);this.ui.dialog.animate({marginTop:"-=10px",opacity:0},300,function(){b.ui.wrap.remove();WE.Dialog.remove(b.id)})},onclose:function(){return!0}};
WE.ui.Post=function(a){this.quotetmpl='<span class="quote-text"><%=text%></span>\t\t\t\t<a href="/user/<%=from._id%>" class="quote-user"><%=from.name%></a>\t\t\t\t<a class="quote-del pull-right" href="javascript:;">\u00d7</a>';this.islock=!1;this.dom=$(a);this.postType=1;this.isFullscreen=!1;this.init()};
WE.ui.Post.prototype={construcotr:WE.ui.Post,init:function(){var a=this.dom;this.ui={form:a.find("form:first"),aim:a.find(".jsaim"),roomid:a.find(".jsroomid"),textarea:a.find("textarea:first"),fullscreen:a.find(".icon-fullscreen"),btnGroup:a.find(".btn-group"),quote:a.find(".quote"),postSendBtn:a.find(".postSendBtn"),modeEdit:a.find(".jsmodeEdit"),modePreview:a.find(".jsmodePreview"),jspreviewbox:a.find(".jspreviewbox")};this.regEvent();this.initSendType();this.setFoucs()},initSendType:function(){var a=
localStorage.getItem("sendType")||1;this.postType=a;var b=this.ui.btnGroup.find(".dropdown-menu a");b.find("span:first").hide();b.eq(2==a?0:1).find("span:first").show()},regEvent:function(){var a=this;this.ui.form.submit(function(){var b=$.trim(a.ui.textarea.val()),c=a.ui.aim.val(),d=a.ui.roomid.val();if(b&&!1==a.islock)a.onpost(d,b,c);return!1});this.ui.fullscreen.click(function(){a.dom.toggleClass("fullscreen");a.isFullscreen=a.isFullscreen?!1:!0;a.updateTextareaHeight()});this.ui.btnGroup.find(".dropdown-toggle").click(function(){a.ui.btnGroup.toggleClass("open");
return!1});this.ui.btnGroup.find(".dropdown-menu a").click(function(){a.ui.btnGroup.toggleClass("open");a.postType=$(this).data("type");localStorage.setItem("sendType",a.postType);a.initSendType()});this.ui.textarea.keydown(function(b){if(13==b.keyCode&&2==a.postType&&!1==a.isFullscreen&&!1==b.shiftKey||13==b.keyCode&&1==a.postType&&!1==a.isFullscreen&&!0==b.ctrlKey)return a.ui.form.trigger("submit"),!1});this.ui.modeEdit.click(function(){a.ui.jspreviewbox.hide();a.ui.textarea.show();a.ui.modePreview.removeClass("active");
a.ui.modeEdit.addClass("active")});this.ui.modePreview.click(function(){a.ui.textarea.hide();a.ui.jspreviewbox.show();a.ui.jspreviewbox.html(WE.markdown.format(a.ui.textarea.val()));a.ui.modeEdit.removeClass("active");a.ui.modePreview.addClass("active")});$(window).resize(function(){a.isFullscreen&&a.updateTextareaHeight()}).keydown(function(b){27==b.keyCode&&a.setMini()})},updateTextareaHeight:function(){if(this.isFullscreen){var a=$(window).height();this.ui.textarea.css("minHeight",a-48-26+"px");
this.ui.jspreviewbox.css("minHeight",a-48-26+"px")}else this.ui.textarea.css("minHeight","45px"),this.ui.jspreviewbox.css("minHeight","45px"),this.ui.jspreviewbox.hide(),this.ui.textarea.show()},onpost:function(a,b,c){},setMini:function(){this.isFullscreen=!1;this.dom.removeClass("fullscreen");this.updateTextareaHeight()},setReply:function(a){var b=this,c=WE.kit.tmpl(this.quotetmpl,a);this.ui.aim.val(a._id);this.ui.quote.html(c).show();this.ui.quote.find(".quote-del").click(function(){b.removeReply()});
this.setFoucs()},setClear:function(){this.ui.textarea.val("");this.removeReply()},setLock:function(){this.islock=!0;this.ui.postSendBtn.attr("disabled",!0)},setFoucs:function(){this.ui.textarea.focus()},removeLock:function(){this.islock=!1;this.ui.postSendBtn.attr("disabled",!1)},removeReply:function(){this.ui.aim.val("");this.ui.quote.hide()}};WE.api=WE.api||{};WE.api.RoomModel=function(){this.postUrl="/api/post";this.updateRoomURL="/api/room-update";this.historyListURL="/api/room-visitors-get";this.uniqueKeyURL="/api/room-key-verify";this.getMoreURL="/api/room-chat-get";this.createRoomURL="/api/room-create";this.searchRoomURL="/api/room-search";this.inviteRoomURL="/api/room-inviteh"};WE.api.RoomModel.prototype=WE.BaseModel.prototype;
WE.api.RoomModel.prototype.mpostChat=function(a,b,c){a={roomid:a,text:b};c&&(a.aim=c);a.to="*";this.post(this.postUrl,a)};WE.api.RoomModel.prototype.postChat=function(a,b,c){this.post(this.postUrl,{roomid:a,text:b,to:"*",aim:c})};WE.api.RoomModel.prototype.create=function(a,b,c){this.post(this.createRoomURL,{topic:a,des:b,pwd:c})};WE.api.RoomModel.prototype.updateRoom=function(a,b,c,d,e){this.post(this.updateRoomURL,{id:a,name:b,topic:c,des:d,password:e})};
WE.api.RoomModel.prototype.updateRoomBase=function(a,b,c){this.post(this.updateRoomURL,{id:a,topic:b,password:c})};WE.api.RoomModel.prototype.getMore=function(a,b){this.get(this.getMoreURL,{roomid:a,time:b})};WE.api.RoomModel.prototype.historyList=function(a){this.get(this.historyListURL,{roomid:a,size:24})};WE.api.RoomModel.prototype.uniqueKey=function(a){this.get(this.uniqueKeyURL,{key:a})};WE.api.RoomModel.prototype.search=function(a){this.get(this.searchRoomURL,{key:a})};
WE.api.RoomModel.prototype.inviteChat=function(a,b,c){this.get(this.inviteRoomURL,{_ids:a,mails:b,roomid:c})};WE.api=WE.api||{};WE.api.NoticeModel=function(){this.noticeCountUrl="/api/notice-count";this.noticeListUrl="/api/notice-list";this.noticeStatusUrl="/api/notice-status"};WE.api.NoticeModel.prototype=WE.BaseModel.prototype;WE.api.NoticeModel.prototype.noticeCount=function(){this.get(this.noticeCountUrl)};WE.api.NoticeModel.prototype.noticeList=function(){this.get(this.noticeListUrl)};WE.api.NoticeModel.prototype.noticeStatus=function(a){this.post(this.noticeStatusUrl,{_id:a})};WE.api=WE.api||{};WE.api.UserModel=function(){this.bindMailURL="/api/user-mail-set";this.setUserNameURL="/api/user-name-update";this.updateAvatorURL="/api/user-avatar-update";this.updateSummaryUrl="/api/user-summary-update";this.contactUsersUrl="/api/user-contact-get";this.verifMailUrl="/api/user-mail-verify"};WE.api.UserModel.prototype=WE.BaseModel.prototype;WE.api.UserModel.prototype.updateUserName=function(a){this.post(this.setUserNameURL,{name:a})};
WE.api.UserModel.prototype.updateMail=function(a,b){this.post(this.bindMailURL,{mail:a,pwd:b})};WE.api.UserModel.prototype.updateAvator=function(a){this.post(this.updateAvatorURL,{gravatarDefault:a})};WE.api.UserModel.prototype.updateUserSummery=function(a){this.post(this.updateSummaryUrl,{summary:a})};WE.api.UserModel.prototype.getContactList=function(){this.get(this.contactUsersUrl)};WE.api.UserModel.prototype.verifMail=function(a){this.get(this.verifMailUrl,{mail:a})};
